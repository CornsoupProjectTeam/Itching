<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Chat Room</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>
    <h1>Chat Room: {{ chat_room_id }}</h1>

    <div id="chat_messages">
        <!-- 이전 채팅 메시지 출력 -->
        {% for message in messages %}
            <p><strong>{{ message.sender_id }}:</strong> {{ message.message_content }}</p>
        {% endfor %}
    </div>

    <form id="chat_form" action="" method="POST">
        <input type="text" id="message_input" name="message" placeholder="메시지를 입력하세요">
        <button type="submit">Send</button>
    </form>

    <!-- 거래가 시작된 글로 이동 버튼 -->
    <button id="transaction_button" onclick="window.location.href='/transaction-started'">거래가 시작된 글로 이동</button>

    <button id="scanner_button" onclick="window.location.href='/scanner'">스캐너</button>

    <button id="quotation_button" onclick="window.location.href='/quotation'">견적서</button>

    <script>
        var socket = io('http://127.0.0.1:5000');  // 서버 주소 명시
        var room = "{{ chat_room_id }}";
        var currentUserId = "{{ current_user_id }}";  // 현재 로그인한 사용자 ID
        var receiverId = "{{ receiver_id }}";  // 상대방 ID

        // 채팅방 입장
        socket.emit('join', {room: room, username: currentUserId});

        // 서버에서 메시지 수신
        socket.on('message', function(data) {
            var chatMessages = document.getElementById('chat_messages');
            chatMessages.innerHTML += "<p><strong>" + data.sender_id + ":</strong> " + data.message + "</p>";
        });

        // 메시지 전송
        document.getElementById('chat_form').addEventListener('submit', function(event) {
            event.preventDefault();
            var messageInput = document.getElementById('message_input');
            var message = messageInput.value;
            if (message.trim() !== "") {
                socket.emit('send_message', {
                    room: room,
                    sender_id: currentUserId,
                    receiver_id: receiverId,
                    message: message
                });
                messageInput.value = '';  // 메시지 전송 후 입력 필드 초기화
            }
        });

        // 수신된 메시지 확인 요청
        socket.emit('get_received_messages', {room: room, user_id: currentUserId});
    </script>
</body>
</html>
